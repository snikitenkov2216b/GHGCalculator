# formulas.py - Данные и логика расчётов формул из PDF
import sympy as sp

# Потенциалы глобального потепления (GWP) из PDF и стандартов
GWP = {
    "CO2": 1,
    "CH4": 28,
    "N2O": 265,
    "CHF3": 11600,
    "CF4": 6630,
    "C2F6": 11100,
    "SF6": 23500,
}

# Коэффициенты из таблиц PDF (пример для категории 6 и 8)
EF_CARBONATES_6_1 = {
    "CaCO3": 0.440,
    "MgCO3": 0.522,
    "CaMg(CO3)2": 0.477,
    "FeCO3": 0.380,
}

EF_CARBONATES_8_1 = {
    "Na2CO3": 0.415,
    "NaHCO3": 0.524,
    "BaCO3": 0.223,
    "K2CO3": 0.318,
    "Li2CO3": 0.596,
    "SrCO3": 0.284,
}

# Таблица 1.1: Коэффициенты выбросов CO2 и содержание углерода по видам топлива (полная, из PDF стр.18-21)
TABLE_1_1 = {
    # Жидкие топлива (нефть и продукты переработки нефти)
    "Нефть, включая промысловый газоконденсат": {"k": 1.430, "NCV": 41.9, "EF": 2.15, "EF_TJ": 73.3, "W": 0.59, "W_TJ": 20.0},
    "Природный газовый конденсат": {"k": 1.508, "NCV": 44.2, "EF": 1.88, "EF_TJ": 64.2, "W": 0.51, "W_TJ": 17.5},
    "Газ попутный нефтяной (нефтяные месторождения)": {"k": 1.154, "NCV": 33.8, "EF": 1.77, "EF_TJ": 60.4, "W": 0.48, "W_TJ": 16.5},
    "Газ попутный нефтяной (газоконденсатные месторождения)": {"k": 1.154, "NCV": 33.8, "EF": 1.64, "EF_TJ": 55.9, "W": 0.45, "W_TJ": 15.3},
    "Газ попутный нефтяной (газовые месторождения)": {"k": 1.154, "NCV": 33.8, "EF": 1.64, "EF_TJ": 55.9, "W": 0.45, "W_TJ": 15.3},
    "Бензин автомобильный": {"k": 1.490, "NCV": 43.7, "EF": 2.03, "EF_TJ": 69.3, "W": 0.55, "W_TJ": 18.9},
    "Бензин авиационный": {"k": 1.490, "NCV": 43.7, "EF": 2.05, "EF_TJ": 70.0, "W": 0.56, "W_TJ": 19.1},
    "Авиационный керосин": {"k": 1.470, "NCV": 43.1, "EF": 2.10, "EF_TJ": 71.5, "W": 0.57, "W_TJ": 19.5},
    "Керосин": {"k": 1.470, "NCV": 43.1, "EF": 2.11, "EF_TJ": 71.9, "W": 0.58, "W_TJ": 19.6},
    "Топливо дизельное": {"k": 1.450, "NCV": 42.5, "EF": 2.17, "EF_TJ": 74.1, "W": 0.59, "W_TJ": 20.2},
    "Мазут топочный": {"k": 1.370, "NCV": 40.2, "EF": 2.27, "EF_TJ": 77.4, "W": 0.62, "W_TJ": 21.1},
    "Мазут флотский": {"k": 1.430, "NCV": 41.9, "EF": 2.27, "EF_TJ": 77.4, "W": 0.62, "W_TJ": 21.1},
    "Топливо печное бытовое": {"k": 1.450, "NCV": 42.5, "EF": 2.27, "EF_TJ": 77.4, "W": 0.62, "W_TJ": 21.1},
    "Газ сжиженный нефтяной": {"k": 1.570, "NCV": 46.0, "EF": 1.85, "EF_TJ": 63.1, "W": 0.50, "W_TJ": 17.2},
    "Другие моторные топлива": {"k": 1.470, "NCV": 43.1, "EF": 2.11, "EF_TJ": 71.9, "W": 0.58, "W_TJ": 19.6},
    "Нефтебитум": {"k": 1.350, "NCV": 39.6, "EF": 2.37, "EF_TJ": 80.7, "W": 0.65, "W_TJ": 22.0},
    "Этан": {"k": 1.583, "NCV": 46.4, "EF": 1.81, "EF_TJ": 61.6, "W": 0.49, "W_TJ": 16.8},
    "Пропан": {"k": 1.570, "NCV": 46.0, "EF": 1.87, "EF_TJ": 63.8, "W": 0.51, "W_TJ": 17.4},
    "Бутан": {"k": 1.570, "NCV": 46.0, "EF": 1.82, "EF_TJ": 62.0, "W": 0.50, "W_TJ": 16.9},
    "Пропан и бутан сжиженные, газы углеводородные и их смеси сжиженные": {"k": 1.570, "NCV": 46.0, "EF": 1.85, "EF_TJ": 63.2, "W": 0.51, "W_TJ": 17.3},
    "Лигроин": {"k": 1.536, "NCV": 45.0, "EF": 2.15, "EF_TJ": 73.3, "W": 0.59, "W_TJ": 20.0},
    "Смазочные материалы": {"k": 1.372, "NCV": 40.2, "EF": 2.15, "EF_TJ": 73.3, "W": 0.59, "W_TJ": 20.0},
    "Газ нефтеперерабатывающих предприятий сухой": {"k": 1.500, "NCV": 44.0, "EF": 1.30, "EF_TJ": 44.4, "W": 0.35, "W_TJ": 12.1},
    "Кокс нефтяной и сланцевый": {"k": 1.080, "NCV": 31.7, "EF": 2.86, "EF_TJ": 97.5, "W": 0.78, "W_TJ": 26.6},
    "Другие нефтепродукты": {"k": 1.430, "NCV": 41.9, "EF": 2.15, "EF_TJ": 73.3, "W": 0.59, "W_TJ": 20.0},
    # Рядовой уголь месторождений
    "Уголь донецкий": {"k": 0.876, "NCV": 25.7, "EF": 2.65, "EF_TJ": 90.2, "W": 0.72, "W_TJ": 24.6},
    "Уголь кузнецкий": {"k": 0.867, "NCV": 25.4, "EF": 2.69, "EF_TJ": 91.9, "W": 0.73, "W_TJ": 25.1},
    "Уголь карагандинский": {"k": 0.726, "NCV": 21.3, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь подмосковный": {"k": 0.335, "NCV": 9.82, "EF": 2.79, "EF_TJ": 95.0, "W": 0.76, "W_TJ": 25.9},
    "Уголь воркутинский": {"k": 0.822, "NCV": 24.1, "EF": 2.71, "EF_TJ": 92.6, "W": 0.74, "W_TJ": 25.3},
    "Уголь интинский": {"k": 0.649, "NCV": 19.0, "EF": 2.73, "EF_TJ": 93.1, "W": 0.75, "W_TJ": 25.4},
    "Уголь челябинский": {"k": 0.552, "NCV": 16.2, "EF": 2.78, "EF_TJ": 94.9, "W": 0.76, "W_TJ": 25.9},
    "Уголь свердловский": {"k": 0.330, "NCV": 9.67, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь башкирский": {"k": 0.264, "NCV": 7.74, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь нерюнгринский": {"k": 0.987, "NCV": 28.9, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь якутский": {"k": 0.751, "NCV": 22.0, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь черемховский": {"k": 0.752, "NCV": 22.0, "EF": 2.75, "EF_TJ": 94.0, "W": 0.75, "W_TJ": 25.7},
    "Уголь азейский": {"k": 0.483, "NCV": 14.2, "EF": 2.75, "EF_TJ": 93.9, "W": 0.75, "W_TJ": 25.6},
    "Уголь читинский": {"k": 0.483, "NCV": 14.2, "EF": 2.90, "EF_TJ": 98.9, "W": 0.79, "W_TJ": 27.0},
    "Уголь гусиноозерский": {"k": 0.506, "NCV": 14.8, "EF": 2.78, "EF_TJ": 94.9, "W": 0.76, "W_TJ": 25.9},
    "Уголь хакасский": {"k": 0.727, "NCV": 21.3, "EF": 2.77, "EF_TJ": 94.4, "W": 0.76, "W_TJ": 25.8},
    "Уголь канско-ачинский": {"k": 0.516, "NCV": 15.1, "EF": 2.87, "EF_TJ": 98.1, "W": 0.78, "W_TJ": 26.8},
    "Уголь тувинский": {"k": 0.906, "NCV": 26.6, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь тунгусский": {"k": 0.754, "NCV": 22.1, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь магаданский": {"k": 0.701, "NCV": 20.5, "EF": 2.73, "EF_TJ": 93.1, "W": 0.75, "W_TJ": 25.4},
    "Уголь арктический(шпицбергенский)": {"k": 0.669, "NCV": 19.6, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь норильский": {"k": 0.761, "NCV": 22.3, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь огоджинский": {"k": 0.447, "NCV": 13.1, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь камчатский": {"k": 0.323, "NCV": 9.47, "EF": 2.73, "EF_TJ": 93.1, "W": 0.75, "W_TJ": 25.4},
    "Уголь Приморья": {"k": 0.506, "NCV": 14.8, "EF": 2.73, "EF_TJ": 93.1, "W": 0.75, "W_TJ": 25.4},
    "Уголь экибастузский": {"k": 0.628, "NCV": 18.4, "EF": 2.77, "EF_TJ": 94.6, "W": 0.76, "W_TJ": 25.8},
    "Уголь алтайский": {"k": 0.782, "NCV": 22.9, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь тугнуйский": {"k": 0.692, "NCV": 20.3, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь прочих месторождений": {"k": 0.768, "NCV": 22.5, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Уголь импортный": {"k": 0.768, "NCV": 22.5, "EF": 2.76, "EF_TJ": 94.2, "W": 0.75, "W_TJ": 25.7},
    "Антрацит": {"k": 0.911, "NCV": 26.7, "EF": 2.88, "EF_TJ": 98.3, "W": 0.79, "W_TJ": 26.8},
    "Коксующийся уголь": {"k": 0.962, "NCV": 28.2, "EF": 2.77, "EF_TJ": 94.6, "W": 0.76, "W_TJ": 25.8},
    "Каменный уголь": {"k": 0.768, "NCV": 22.5, "EF": 2.77, "EF_TJ": 94.6, "W": 0.76, "W_TJ": 25.8},
    "Бурый уголь": {"k": 0.467, "NCV": 13.7, "EF": 2.96, "EF_TJ": 101.0, "W": 0.81, "W_TJ": 27.6},
    "Сланцы горючие": {"k": 0.300, "NCV": 8.79, "EF": 3.14, "EF_TJ": 107.0, "W": 0.86, "W_TJ": 29.2},
    "Брикеты угольные": {"k": 0.605, "NCV": 17.7, "EF": 2.86, "EF_TJ": 97.5, "W": 0.78, "W_TJ": 26.6},
    "Кокс металлургический": {"k": 0.990, "NCV": 29.0, "EF": 3.14, "EF_TJ": 107.0, "W": 0.86, "W_TJ": 29.2},
    "Смола каменноугольная коксохимических заводов": {"k": 1.300, "NCV": 38.1, "EF": 2.37, "EF_TJ": 80.7, "W": 0.65, "W_TJ": 22.0},
    # Газы искусственные горючие
    "Газ горючий искусственный коксовый": {"k": 0.570, "NCV": 16.7, "EF": 1.30, "EF_TJ": 44.4, "W": 0.35, "W_TJ": 12.1},
    "Газ горючий искусственный доменный": {"k": 0.143, "NCV": 4.19, "EF": 7.62, "EF_TJ": 260.0, "W": 2.08, "W_TJ": 71.0},
    "Газ горючий искусственный конвертерный": {"k": 0.240, "NCV": 7.06, "EF": 5.33, "EF_TJ": 182, "W": 0.35, "W_TJ": 49.6},
    # Природный газ
    "Газ горючий природный(естественный)": {"k": 1.129, "NCV": 33.08, "EF": 1.59, "EF_TJ": 54.4, "W": 0.43, "W_TJ": 14.8},
    "Газ компримированный": {"k": 1.129, "NCV": 33.08, "EF": 1.59, "EF_TJ": 54.4, "W": 0.43, "W_TJ": 14.8},
    "Газ сжиженный": {"k": 1.570, "NCV": 46.0, "EF": 1.65, "EF_TJ": 56.4, "W": 0.45, "W_TJ": 15.4},
    # Торф
    "Торф топливный": {"k": 0.340, "NCV": 10.0, "EF": 3.11, "EF_TJ": 106.0, "W": 0.85, "W_TJ": 28.9},
    "Брикеты и полубрикеты торфяные": {"k": 0.600, "NCV": 17.6, "EF": 3.11, "EF_TJ": 106.0, "W": 0.85, "W_TJ": 28.9},
    # Отходы
    "Отходы бытовые (небиологическая фракция)": {"k": 0.341, "NCV": 10.0, "EF": 2.69, "EF_TJ": 91.7, "W": 0.73, "W_TJ": 25.0},
    "Прочие горючие отходы технологических производств": {"k": 1.000, "NCV": 29.3, "EF": 4.19, "EF_TJ": 143.0, "W": 1.14, "W_TJ": 39.0},
    "Нефтяные отходы": {"k": 1.372, "NCV": 40.2, "EF": 2.12, "EF_TJ": 72.2, "W": 0.58, "W_TJ": 19.7},
    # Биотоплива
    "Биобензин": {"k": 0.921, "NCV": 27.0, "EF": 2.07, "EF_TJ": 70.8, "W": 0.57, "W_TJ": 19.3},
    "Био-дизтопливо": {"k": 0.921, "NCV": 27.0, "EF": 2.07, "EF_TJ": 70.8, "W": 0.57, "W_TJ": 19.3},
    "Другие виды жидкого биотоплива": {"k": 0.935, "NCV": 27.4, "EF": 2.33, "EF_TJ": 79.6, "W": 0.63, "W_TJ": 21.7},
}

# Таблица 1.2: Плотность CO2 и CH4 (из PDF стр.22)
TABLE_1_2 = {
    1: {"T": "273.15 K (0 °C); 101.325 кПа", "rho_CO2": 1.9768, "rho_CH4": 0.7170},
    2: {"T": "288.15 K (15 °C); 101.325 кПа", "rho_CO2": 1.8738, "rho_CH4": 0.6797},
    3: {"T": "293.15 K (20 °C); 101.325 кПа", "rho_CO2": 1.8393, "rho_CH4": 0.6680},
}

# Категории источников выбросов из Приложения N1 PDF (с полными описаниями формул)
CATEGORIES = {
    "1. Стационарное сжигание топлива": {
        "(1.1)": "выбросы CO2 от стационарного сжигания топлива",
        "(1.2а)": "расход топлива в энергетическом эквиваленте (т у.т.)",
        "(1.2б)": "расход топлива в энергетическом эквиваленте (ТДж)",
        "(1.3)": "коэффициент выбросов CO2 для газообразного топлива (объемная доля)",
        "(1.4)": "коэффициент выбросов CO2 для газообразного топлива (массовая доля)",
        "(1.5)": "коэффициент выбросов CO2 для твердого и жидкого топлива",
        "(1.6)": "содержание углерода в коксе",
        "(1.7)": "содержание углерода в топливе",
        "(1.8)": "коэффициент окисления твердого топлива (на основе недожога)",
        "(1.9)": "коэффициент окисления твердого топлива (на основе углерода в золе)",
        "(1.10)": "содержание углерода в коксующихся углях",
    },
    # ... (для других категорий заглушки; реализуем последовательно)
    "2. Сжигание в факелах": {},
    # и т.д.
}

# Описания формул и требуемые входы (полные для категории 1)
FORMULA_DESCRIPTIONS = {
    "(1.1)": {"description": "E_CO2,y = sum_{j=1}^n (FC_j,y * EF_CO2,j,y * OF_j,y)", "inputs": ["FC_j,y (расход топлива j, тыс. м3/т/т у.т./ТДж)", "EF_CO2,j,y (коэффициент выбросов CO2, т CO2/ед.)", "OF_j,y (коэффициент окисления, доля)"]},
    "(1.2а)": {"description": "FC_j,y = FC'_j,y * k_j,y", "inputs": ["FC'_j,y (расход в натуральном выражении, т/тыс. м3)", "k_j,y (коэффициент перевода в т у.т., т у.т./т/т у.т./тыс. м3)"]},
    "(1.2б)": {"description": "FC_j,y = FC'_j,y * NCV_j,y * 10^{-3}", "inputs": ["FC'_j,y (расход в натуральном выражении, т/тыс. м3)", "NCV_j,y (низшая теплота сгорания, МДж/кг/МДж/м3)"]},
    "(1.3)": {"description": "EF_CO2,j,y = sum_{i=1}^n (W_i,j,y * n_C,i * rho_CO2 * 10^{-3})", "inputs": ["W_i,j,y (объемная доля i-компонента, % об.)", "n_C,i (атомы углерода в молекуле i)", "rho_CO2 (плотность CO2, кг/м3)"]},
    "(1.4)": {"description": "EF_CO2,j,y = sum_{i=1}^n (W_i,j,y * n_C,i * 44.011 * rho_j,y * 10^{-3} / M_i)", "inputs": ["W_i,j,y (массовая доля i-компонента, % мас.)", "n_C,i (моли углерода на моль i)", "rho_j,y (плотность топлива, кг/м3)", "M_i (молярная масса i, г/моль)"]},
    "(1.5)": {"description": "EF_CO2,j,y = W_C,j,y * 3.664", "inputs": ["W_C,j,y (содержание углерода, т C/т/т C/тыс. м3)"]},
    "(1.6)": {"description": "W_C,кокс,y = (100 - A_кокс,y - V_кокс,y - S_кокс,y) / 100", "inputs": ["A_кокс,y (зола в коксе, %)", "V_кокс,y (летучие в коксе, %)", "S_кокс,y (сера в коксе, %)"]},
    "(1.7)": {"description": "W_C,j,y = EF_CO2,j,y / 3.664", "inputs": ["EF_CO2,j,y (коэффициент выбросов, т CO2/т/т CO2/тыс. м3)"]},
    "(1.8)": {"description": "OF_j,y = (100 - q4) / 100", "inputs": ["q4 (потери тепла от недожога, %)"]},
    "(1.9)": {"description": "OF_j,y = 1 - CC_A,y / CC_F,y", "inputs": ["CC_A,y (углерод в золе/шлаке, т)", "CC_F,y (углерод в топливе, т)"]},
    "(1.10)": {"description": "W_C,кокс.уголь,y = (100 - A_кокс.уголь,y - 0.47 * V_кокс.уголь,y) / 100", "inputs": ["A_кокс.уголь,y (зола в углях, %)", "V_кокс.уголь,y (летучие в углях, %)"]},
    # Заглушки для других категорий
}

# Функция расчёта (заглушка: сумма вводов * GWP CO2; в шаге 3 реализуем sympy для формул)
def calculate_formula(formula_number, inputs):
    # Валидация: все inputs - числа
    try:
        values = [float(i) for i in inputs]
    except ValueError:
        raise ValueError("Все входы должны быть числами")
    if any(v < 0 for v in values):
        raise ValueError("Значения не могут быть отрицательными")
    # Заглушка расчёта
    result = sum(values) * GWP["CO2"]
    return result